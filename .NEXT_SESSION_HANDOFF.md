# MathCamp - Next Session Handoff

## ğŸ¯ STRATEGIC FOCUS: Quiz Engine Refactoring (P0 Architecture)

### Executive Summary
The current MathCamp implementation is **functional but architecturally fragmented**. A comprehensive Quiz Engine architecture proposal has been reviewed and assessed. This handoff outlines a **pragmatic, phased implementation** of **40% of the proposed architecture at 100% quality** - focusing exclusively on P0 components that deliver maximum value for 1st graders.

---

## ğŸ“‹ IMPLEMENTATION PLAN: P0 Components

### Phase 1: Core Type System & Foundation (Week 1)
**Goal**: Establish type-safe foundation for all quiz operations

#### 1.1 Enhanced Type System â­â­â­â­â­
**Location**: `src/core/types/`
**Effort**: Medium | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/core/types/question.ts` - Comprehensive question types
- [ ] Create `src/core/types/answer.ts` - Answer data structures
- [ ] Create `src/core/types/evaluation.ts` - Evaluation result types
- [ ] Create `src/core/types/progress.ts` - Enhanced progress tracking types
- [ ] Migrate existing `src/types/index.ts` types to new structure

**New Type Definitions**:
```typescript
// src/core/types/question.ts
export type QuestionType =
  | 'addition' | 'subtraction' | 'multiplication' | 'division'
  | 'comparison' | 'fact-family' | 'word-problem'
  | 'counting' | 'counting-sequence' | 'pattern'

export type DifficultyLevel = 1 | 2 | 3 | 4 | 5

export interface Question {
  id: string
  type: QuestionType
  difficulty: DifficultyLevel

  problem: ProblemData
  answer: AnswerData
  metadata: QuestionMetadata
  assets?: AssetReferences
}

export interface ProblemData {
  text: string
  components: ProblemComponent[]
  format: 'text' | 'visual' | 'mixed'
}

export interface AnswerData {
  correct: string | number | string[]
  acceptableAlternatives?: (string | number)[]
  format: 'numeric' | 'multiple-choice' | 'text' | 'visual-selection'
  options?: AnswerOption[]
}

export interface QuestionMetadata {
  generatedAt: number
  estimatedTime: number  // milliseconds
  skillTags: string[]
  learningObjectives: string[]
}
```

**Success Criteria**:
- All existing components compile with new types
- Zero `any` types in question/answer interfaces
- Full IDE autocomplete support

---

#### 1.2 Generator Registry Pattern â­â­â­â­â­
**Location**: `src/core/generators/`
**Effort**: Medium | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/core/generators/GeneratorRegistry.ts` - Central registry
- [ ] Create `src/core/generators/IQuestionGenerator.ts` - Generator interface
- [ ] Refactor `src/features/math-types/problemGenerator.ts` to use registry
- [ ] Create `AdditionGenerator.ts` implementing IQuestionGenerator
- [ ] Create `SubtractionGenerator.ts` implementing IQuestionGenerator
- [ ] Migrate fact family, word problem, counting generators

**Implementation**:
```typescript
// src/core/generators/IQuestionGenerator.ts
export interface IQuestionGenerator {
  type: QuestionType
  supportedDifficulties: DifficultyLevel[]
  generate(params: GenerationParams): Question
  validate(question: Question): boolean
}

// src/core/generators/GeneratorRegistry.ts
export class GeneratorRegistry {
  private generators: Map<QuestionType, IQuestionGenerator> = new Map()

  register(generator: IQuestionGenerator): void
  get(type: QuestionType): IQuestionGenerator
  generate(params: GenerationParams): Question
}
```

**Success Criteria**:
- All 6 question types migrated to generator pattern
- Adding new question type requires <50 lines of code
- Zero breaking changes to existing UI components

---

### Phase 2: Event System & Asset Management (Week 2)
**Goal**: Decouple animations/sounds from quiz logic

#### 2.1 Event Bus for UI Feedback â­â­â­â­â­
**Location**: `src/core/events/`
**Effort**: Medium | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/core/events/EventBus.ts` - Lightweight event system
- [ ] Define event types: `question:answered`, `answer:correct`, `answer:incorrect`, `streak:started`, etc.
- [ ] Create `src/presentation/hooks/useEventHandler.ts` - React integration
- [ ] Migrate confetti triggering to event-based system
- [ ] Migrate sound effects to event-based system (when implemented)

**Implementation**:
```typescript
// src/core/events/EventBus.ts
export type EventName =
  | 'question:answered'
  | 'answer:correct'
  | 'answer:incorrect'
  | 'streak:started'
  | 'achievement:unlocked'

export interface Event<T = any> {
  name: EventName
  timestamp: number
  data: T
}

export class EventBus {
  on<T>(eventName: EventName, handler: (event: Event<T>) => void): () => void
  emit<T>(eventName: EventName, data: T): Promise<void>
}
```

**React Hook Integration**:
```typescript
// src/presentation/hooks/useEventHandler.ts
export function useEventHandler() {
  const eventBus = useEventBus()

  useEffect(() => {
    const unsubCorrect = eventBus.on('answer:correct', async (event) => {
      // Trigger confetti
      if (event.data.streak >= 3) {
        // Trigger special animation
      }
    })

    return () => unsubCorrect()
  }, [eventBus])
}
```

**Success Criteria**:
- Confetti animation triggers via events, not direct calls
- UI components subscribe to events declaratively
- Easy to add new animations without touching quiz logic

---

#### 2.2 Asset Management System â­â­â­â­â­
**Location**: `src/infrastructure/assets/`
**Effort**: Medium | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/infrastructure/assets/AssetManager.ts` - Asset orchestrator
- [ ] Create `src/infrastructure/assets/SoundManager.ts` - Sound loading/playback
- [ ] Create `src/infrastructure/assets/AnimationManager.ts` - Animation coordination
- [ ] Create `assets/manifest.ts` - Asset catalog
- [ ] Implement preloading for critical assets
- [ ] Create event-to-asset mapping

**Implementation**:
```typescript
// src/infrastructure/assets/AssetManager.ts
export class AssetManager {
  async register(asset: Asset): Promise<void>
  async load(assetId: string): Promise<any>
  async play(assetId: string, options?: AssetOptions): Promise<void>
  preloadBatch(assetIds: string[]): Promise<void[]>
}

// assets/manifest.ts
export const ASSET_MANIFEST: Asset[] = [
  {
    id: 'sound:success',
    type: 'sound',
    path: '/assets/sounds/success.mp3',
    preload: true
  },
  {
    id: 'animation:confetti',
    type: 'animation',
    path: '/assets/animations/confetti.json',
    preload: true
  }
]

// Event-driven triggers
export const ASSET_TRIGGERS: Record<string, AssetReference[]> = {
  'answer:correct': [
    { id: 'sound:success', type: 'sound', options: { volume: 0.7 } },
    { id: 'animation:confetti', type: 'animation' }
  ]
}
```

**Success Criteria**:
- Assets preload on app start (<2s)
- Sounds play without jank
- Easy to add new sounds by editing manifest only

---

### Phase 3: Quiz Engine Orchestrator (Week 3)
**Goal**: Centralized quiz session management

#### 3.1 Quiz Engine Core â­â­â­â­â­
**Location**: `src/quiz/`
**Effort**: High | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/quiz/QuizEngine.ts` - Main orchestrator
- [ ] Create `src/quiz/types.ts` - Quiz-specific types
- [ ] Create `src/quiz/Evaluator.ts` - Answer checking logic
- [ ] Create `src/quiz/Scorer.ts` - Point calculation
- [ ] Refactor `App.tsx` to use QuizEngine instead of local state
- [ ] Create `src/presentation/hooks/useQuizEngine.ts` - React integration

**Implementation**:
```typescript
// src/quiz/QuizEngine.ts
export interface QuizConfig {
  questionTypes: QuestionType[]
  difficulty: DifficultyLevel | 'adaptive'
  questionsPerSession: number
  enableHints: boolean
}

export interface QuizSession {
  id: string
  config: QuizConfig
  questions: Question[]
  currentIndex: number
  answers: Map<string, EvaluationResult>
  state: 'active' | 'paused' | 'completed'
}

export class QuizEngine extends EventEmitter {
  async startSession(config: QuizConfig): Promise<QuizSession>
  async submitAnswer(answer: string | number): Promise<EvaluationResult>
  getCurrentQuestion(): Question
  nextQuestion(): void
  async endSession(): Promise<SessionStats>
}
```

**Migration from App.tsx**:
- Move question generation from `App.tsx` to `QuizEngine`
- Move session state from React state to `QuizEngine`
- Keep only UI state in React components

**Success Criteria**:
- `App.tsx` reduced from ~500 lines to <200 lines
- Quiz logic testable without React
- Session can be paused/resumed

---

### Phase 4: Enhanced Progress Tracking (Week 4)
**Goal**: Rich learning insights and achievements

#### 4.1 Progress Tracker with Mastery Levels â­â­â­â­â­
**Location**: `src/quiz/progress/`
**Effort**: High | **Value**: Very High | **Priority**: P0

**Tasks**:
- [ ] Create `src/quiz/progress/ProgressTracker.ts` - Track learning progress
- [ ] Create `src/quiz/progress/types.ts` - Progress data models
- [ ] Create `src/quiz/progress/AchievementEngine.ts` - Achievement unlocking
- [ ] Create `src/quiz/progress/StreakManager.ts` - Streak tracking
- [ ] Enhance `src/hooks/useProgress.tsx` to use new tracker
- [ ] Create parent dashboard component

**New Data Models**:
```typescript
// src/quiz/progress/types.ts
export interface MasteryData {
  questionType: QuestionType
  level: number  // 0-100
  questionsAttempted: number
  questionsCorrect: number
  averageTime: number
  lastPracticed: number
  trend: 'improving' | 'stable' | 'declining'
}

export interface ProgressStats {
  totalSessions: number
  totalQuestions: number
  totalCorrect: number
  averageAccuracy: number
  currentStreak: number
  bestStreak: number
  masteryLevels: Map<QuestionType, MasteryData>
}
```

**Features**:
- Mastery level calculation per question type
- Skill-based progress tracking
- Achievement system with rarities (common, rare, epic)
- Daily streak tracking
- Parent-friendly dashboard

**Success Criteria**:
- Mastery levels update after each session
- Achievements unlock automatically
- Parent can see child's progress without cloud

---

### Phase 5: Simple Storage & State (Week 4)
**Goal**: Reliable local persistence

#### 5.1 Simplified Storage Layer â­â­â­
**Location**: `src/infrastructure/storage/`
**Effort**: Low | **Value**: Moderate | **Priority**: P0

**Tasks**:
- [ ] Create `src/infrastructure/storage/storage.ts` - Simple wrapper
- [ ] Add IndexedDB fallback for large progress data
- [ ] Create `src/infrastructure/storage/migrations.ts` - Data migrations
- [ ] Migrate existing localStorage usage to new storage

**Implementation** (Simple, not over-engineered):
```typescript
// src/infrastructure/storage/storage.ts
export const storage = {
  async get<T>(key: string): Promise<T | null> {
    try {
      const data = localStorage.getItem(key)
      return data ? JSON.parse(data) : null
    } catch {
      // Fallback to IndexedDB for large data
      return await indexedDB.get(key)
    }
  },

  async set<T>(key: string, value: T): Promise<void> {
    try {
      localStorage.setItem(key, JSON.stringify(value))
    } catch (e) {
      // Quota exceeded, use IndexedDB
      await indexedDB.set(key, value)
    }
  }
}
```

**Success Criteria**:
- No data loss on browser close
- Handles quota exceeded gracefully
- Migration from old format works

---

## ğŸ“Š POSTHOG INTEGRATION (Hybrid Approach)

### Privacy-First Analytics Strategy

**Two-Layer Architecture:**
1. **PostHog (Remote)** - Anonymous usage metrics, MAU/DAU, feature flags
2. **Local Storage** - All child learning data, progress, achievements

### What Goes to PostHog âœ…
- **Application health**: MAU/DAU, session duration (bucketed), app version
- **Feature usage**: Which activities selected, how many problems attempted
- **Performance**: Load times, animation FPS, error rates
- **Feature flags**: Remote control for gradual rollouts, A/B testing, kill switches
- **NO CHILD DATA**: No names, no answers, no correctness, no mastery levels

### What Stays Local ğŸ”’
- **All learning progress**: Mastery levels, skill tracking, detailed problem history
- **Personal data**: Child names, specific answers, time per problem
- **Achievements**: Unlocked badges, streaks, scores
- **Problem attempts**: Question/answer pairs, correctness, attempts

### Implementation: AnalyticsService
```typescript
// Dual-layer service routes events appropriately
class AnalyticsService {
  trackSessionStart()      â†’ PostHog (anonymous) + Local (detailed)
  trackActivitySelected()  â†’ PostHog (usage) + Local (preferences)
  trackProblemAnswered()   â†’ Local ONLY (too detailed for PostHog)
  trackSessionCompleted()  â†’ PostHog (aggregated) + Local (full data)
}
```

### Privacy Configuration
```typescript
posthog.init('<key>', {
  autocapture: false,              // Manual events only
  disable_session_recording: true, // Never record kids
  disable_surveys: true,
  sanitize_properties: stripPII    // Remove accidental PII
})
```

---

## ğŸš« EXPLICITLY EXCLUDED (Do Not Implement)

These components from the architecture proposal are **NOT** being implemented:

1. âŒ **WASM Integration** - Unnecessary for 1st grade math
2. âŒ **Python ML via Pyodide** - 10MB bundle for simple difficulty adjustment
3. âŒ **Full Plugin Manager** - Over-engineered for static question types
4. âŒ **Command Pattern** - Kids don't need undo functionality
5. âŒ **4-Layer Strict Architecture** - Use simplified 3-layer instead
6. âŒ **Advanced Metrics** (p95/p99) - Basic stats sufficient
7. âŒ **Storage Adapter Pattern** - Simple wrapper adequate

---

## ğŸ“ Proposed Directory Structure

```
mathcamp/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                      # Pure business logic (no React)
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”œâ”€â”€ question.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ answer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ evaluation.ts
â”‚   â”‚   â”‚   â””â”€â”€ progress.ts
â”‚   â”‚   â”œâ”€â”€ generators/
â”‚   â”‚   â”‚   â”œâ”€â”€ IQuestionGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ GeneratorRegistry.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ AdditionGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ SubtractionGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ FactFamilyGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ WordProblemGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ CountingGenerator.ts
â”‚   â”‚   â”‚   â””â”€â”€ SequenceGenerator.ts
â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚       â”œâ”€â”€ EventBus.ts
â”‚   â”‚       â””â”€â”€ types.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ quiz/                      # Quiz orchestration
â”‚   â”‚   â”œâ”€â”€ QuizEngine.ts
â”‚   â”‚   â”œâ”€â”€ Evaluator.ts
â”‚   â”‚   â”œâ”€â”€ Scorer.ts
â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ progress/
â”‚   â”‚       â”œâ”€â”€ ProgressTracker.ts
â”‚   â”‚       â”œâ”€â”€ AchievementEngine.ts
â”‚   â”‚       â”œâ”€â”€ StreakManager.ts
â”‚   â”‚       â””â”€â”€ types.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/            # Technical services
â”‚   â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â”‚   â””â”€â”€ migrations.ts
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â”œâ”€â”€ AssetManager.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ SoundManager.ts
â”‚   â”‚   â”‚   â””â”€â”€ AnimationManager.ts
â”‚   â”‚   â””â”€â”€ analytics/
â”‚   â”‚       â”œâ”€â”€ AnalyticsService.ts    # Dual-layer routing
â”‚   â”‚       â”œâ”€â”€ LocalAnalytics.ts      # Local event storage
â”‚   â”‚       â”œâ”€â”€ PostHogService.ts      # PostHog wrapper
â”‚   â”‚       â””â”€â”€ FeatureFlagService.ts  # Remote + local flags
â”‚   â”‚
â”‚   â”œâ”€â”€ presentation/              # React UI (existing + hooks)
â”‚   â”‚   â”œâ”€â”€ components/            # (existing)
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useQuizEngine.ts   # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ useEventHandler.ts # NEW
â”‚   â”‚   â”‚   â”œâ”€â”€ useAssetManager.ts # NEW
â”‚   â”‚   â”‚   â””â”€â”€ useProgress.tsx    # Enhanced
â”‚   â”‚   â””â”€â”€ state/
â”‚   â”‚       â””â”€â”€ QuizContext.tsx    # NEW
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                  # (existing - gradually refactor)
â”‚   â”œâ”€â”€ App.tsx                    # (simplified with QuizEngine)
â”‚   â””â”€â”€ main.tsx
â”‚
â””â”€â”€ assets/
    â”œâ”€â”€ sounds/                    # NEW - add sound files
    â”œâ”€â”€ animations/
    â””â”€â”€ manifest.ts                # NEW - asset catalog
```

---

## ğŸ“‹ TODO List for Next Session

### Week 1: Foundation
- [ ] Create `src/core/types/` directory structure
- [ ] Implement comprehensive question type system
- [ ] Create `GeneratorRegistry` pattern
- [ ] Migrate `AdditionGenerator` to new pattern
- [ ] Migrate `SubtractionGenerator` to new pattern
- [ ] Write unit tests for generators

### Week 2: Events, Assets & Analytics
- [ ] Implement `EventBus` class
- [ ] Create event type definitions
- [ ] Build `AssetManager` core
- [ ] Create `assets/manifest.ts`
- [ ] Add 3-5 sound effect files (success, error, streak)
- [ ] Integrate event-driven confetti
- [ ] **Install PostHog**: `bun add posthog-js @posthog/react`
- [ ] **Create `AnalyticsService`** - Dual-layer routing
- [ ] **Create `LocalAnalytics`** - Local event storage
- [ ] **Create `FeatureFlagService`** - Remote + local fallback
- [ ] **Configure PostHog** with privacy-first settings

### Week 3: Quiz Engine
- [ ] Build `QuizEngine` orchestrator
- [ ] Implement `Evaluator` logic
- [ ] Create `Scorer` with time-based bonuses
- [ ] Refactor `App.tsx` to use `QuizEngine`
- [ ] Create `useQuizEngine` React hook
- [ ] Test session lifecycle

### Week 4: Progress & Polish
- [ ] Implement `ProgressTracker` with mastery levels
- [ ] Build `AchievementEngine`
- [ ] Create parent dashboard UI
- [ ] Add 10+ achievements
- [ ] Implement streak animations
- [ ] Storage migration script

---

## ğŸ¯ Success Metrics

After completing P0 implementation:

### Code Quality
- [ ] `App.tsx` reduced to <200 lines (currently ~500)
- [ ] Zero `any` types in core logic
- [ ] 80%+ test coverage for generators
- [ ] <2s app load time

### User Experience
- [ ] Sounds play without lag
- [ ] Smooth 60fps animations
- [ ] Accurate mastery level calculation
- [ ] 5+ achievements unlocked in first session

### Maintainability
- [ ] Add new question type in <1 hour
- [ ] Add new sound in <5 minutes
- [ ] Add new achievement in <10 minutes

---

## âš ï¸ Critical Reminders

1. **NO SERVER FEATURES** - All data stays local per CLAUDE.md
2. **SHIP 40%, NOT 100%** - Focus on P0 components only
3. **TEST WITH REAL 6-YEAR-OLDS** - Get feedback early
4. **PERFORMANCE MATTERS** - Kids have short attention spans
5. **ACCESSIBILITY** - Screen reader support, large touch targets

---

## ğŸ”„ Migration Strategy

### Backward Compatibility
- Old localStorage format must migrate automatically
- Existing UI components work during transition
- Feature flags for gradual rollout

### Phased Rollout
1. **Week 1-2**: Build new system alongside old
2. **Week 3**: Start migrating components
3. **Week 4**: Complete migration, remove old code
4. **Week 5**: Polish, test, optimize

---

## Current Status
âœ… **Application Fixed and Running** - Dev server running at http://localhost:3000/ with all core issues resolved.
âœ… **PostHog Integration Complete** - Hybrid analytics system implemented with privacy-first approach.

## Completed Features (Existing)
- âœ… Addition, subtraction problems with visual aids
- âœ… Fact families with interactive input fields
- âœ… Word problems with 20+ templates across 5 themes
- âœ… Comparison questions integrated into word problems
- âœ… Counting exercises with mixed objects and layout variations
- âœ… Number sequences (count by 1, 2, 5, 10)
- âœ… Local storage progress tracking with achievements
- âœ… Kid-friendly animations and colors
- âœ… Question count selector (5, 10, 20)

## New Features (This Session - PostHog Integration)
- âœ… **PostHog packages installed** (`posthog-js`, `@posthog/react`)
- âœ… **Privacy-first PostHog configuration** in `main.tsx`
- âœ… **AnalyticsService** - Dual-layer router (PostHog + Local)
- âœ… **LocalAnalytics** - Private child learning data storage
- âœ… **FeatureFlagService** - Remote flags with local fallbacks
- âœ… **React hooks** - `useAnalytics()`, `useFeatureFlags()`, `useFeatureFlag()`
- âœ… **App.tsx integration** - Tracking session lifecycle, activity selection
- âœ… **Environment config** - `.env.example` for PostHog credentials
- âœ… **Documentation** - `POSTHOG_SETUP.md` and `POSTHOG_STRATEGY.md`

## Current Menu Activities
1. Addition (â•)
2. Subtraction (â–)
3. Fact Families (ğŸ )
4. Word Problems (ğŸ“–)
5. Counting (ğŸ”¢)
6. Number Sequences (â¬†ï¸)

## Development Commands
```bash
bun run dev        # Start dev server (port 3000)
bun run build      # Build for production
bun run type-check # Check TypeScript types
bun test           # Run tests (after adding)
```

---

## ğŸ“¦ PostHog Implementation Details

### Installation
```bash
bun add posthog-js @posthog/react
```

### Initialization (src/main.tsx)
```typescript
import posthog from 'posthog-js'
import { PostHogProvider } from '@posthog/react'

posthog.init('<ph_project_api_key>', {
  api_host: 'https://us.i.posthog.com',

  // Privacy-first configuration
  autocapture: false,
  capture_pageview: false,
  disable_session_recording: true,
  disable_surveys: true,

  // Sanitize properties
  sanitize_properties: (properties) => {
    const sanitized = { ...properties }
    delete sanitized.name
    delete sanitized.email
    delete sanitized.childId
    delete sanitized.answer
    return sanitized
  }
})

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <PostHogProvider client={posthog}>
      <App />
    </PostHogProvider>
  </React.StrictMode>
)
```

### AnalyticsService Implementation
```typescript
// src/infrastructure/analytics/AnalyticsService.ts
export class AnalyticsService {
  constructor(
    private postHog: PostHog,
    private localAnalytics: LocalAnalytics
  ) {}

  trackSessionStart(): void {
    // PostHog: Anonymous usage
    this.postHog.capture('session_started', {
      version: APP_VERSION,
      platform: 'web'
    })

    // Local: Detailed tracking
    this.localAnalytics.createSession()
  }

  trackActivitySelected(type: QuestionType): void {
    this.postHog.capture('activity_selected', {
      activity_type: type
    })
    this.localAnalytics.recordActivity(type)
  }

  trackProblemAnswered(attempt: ProblemAttempt): void {
    // Local ONLY - too detailed for PostHog
    this.localAnalytics.recordAttempt(attempt)
  }

  trackSessionCompleted(summary: SessionSummary): void {
    // PostHog: Aggregated only
    this.postHog.capture('session_completed', {
      activity_type: summary.type,
      total_problems: summary.total,
      duration_bucket: this.bucketDuration(summary.duration)
    })

    // Local: Full details
    this.localAnalytics.completeSession(summary)
  }
}
```

### Feature Flags
```typescript
// src/infrastructure/analytics/FeatureFlagService.ts
export class FeatureFlagService {
  async isEnabled(flag: string): Promise<boolean> {
    // Remote first, fallback to local
    const remote = this.postHog.isFeatureEnabled(flag)
    return remote ?? LOCAL_FLAGS[flag] ?? false
  }
}

// Usage in components
const showMultiplication = useFeatureFlagEnabled('multiplication-activity')
```

### Events to Track (PostHog)
- `app_started` - App launch
- `session_started` - New learning session
- `activity_selected` - Feature usage
- `session_completed` - Session finished (aggregated)
- `error_occurred` - App errors
- `feature_enabled` - Feature flag changed

### Events to Track (Local Only)
- `problem_generated` - Question created
- `problem_answered` - Answer submitted (with correctness)
- `achievement_unlocked` - Badge earned
- `mastery_updated` - Skill level changed
- `streak_updated` - Streak count changed

---

## ğŸ“ Questions for Next Session

1. Should adaptive difficulty use ML or simple rules? (**Recommendation: Simple rules**)
2. What sound effects are most encouraging for 6-year-olds?
3. Should parent dashboard be password-protected?
4. How many achievements total? (**Recommendation: Start with 20**)
5. **PostHog Project**: What's the API key and host? (Set up project at posthog.com)

---

## ğŸ“ Educational Philosophy Reminder

MathCamp is for **1st graders (ages 6-7)**:
- Celebrate effort, not just correctness
- Visual feedback > text feedback
- Progress over perfection
- Fun > rigorous testing
- Privacy > analytics

**Ship the 40% that matters. Iterate based on real kid feedback.**
